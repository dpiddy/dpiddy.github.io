<!doctype html><html><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Injecting errors to test idempotency · Dan Peterson</title><link rel=stylesheet href=/css/rocinante.css><body><header><h2><a href=https://danp.net/>‹ Dan Peterson</a></h2></header><main><div class=post><div class=title-group><div class=title><h1>Injecting errors to test idempotency</h1></div><div class=date><h5>Feb 24, 2016</h5></div></div><article class=content><p>As part of <a href=https://www.heroku.com/private-spaces target=_blank>Heroku Private Spaces</a> we attach extra <a href=http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html target=_blank>Elastic Network Interfaces</a>
to instances, and we do that in Go with <a href=https://github.com/aws/aws-sdk-go/ target=_blank>aws-sdk-go</a>.</p><p>The process isn&rsquo;t the most idempotent and we recently discovered we were occasionally leaking ENIs. This could happen if we created an ENI and then encountered an error later in the process, such as when attaching it to an instance. I set out this morning to find a better way.</p><p>When an ENI is created, it can be assigned a description. Previously we used descriptions only for the ENI&rsquo;s function (eg, &ldquo;nat&rdquo;) and not anything specific to the instance the ENI was intended for. After seeing that listing ENIs allows filtering on the description, I decided to make that the foundation of the new approach.</p><p>The new process looks like this:</p><ol><li>try finding the ENI with the right description, based on its function and intended instance&rsquo;s ID</li><li>if no ENI was found, create it with the description</li><li>if the ENI was found AND it&rsquo;s attached to an instance already AND its DeleteOnTermination attribute is set to <code>true</code>, we&rsquo;re done</li><li>otherwise, attach it to the instance if necessary</li><li>set the DeleteOnTermination attribute to <code>true</code></li></ol><p>After getting the new process working, I wanted to verify it would be fully idempotent when encountering AWS or other errors. There&rsquo;s not really a knob to turn to make AWS error for the API calls involved in the process so I thought I&rsquo;d try some simple error injection.</p><p>I added this to the code:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=color:#a90d91>var</span> <span style=color:#000>randomError</span> = <span style=color:#000>errors</span>.<span style=color:#000>New</span>(<span style=color:#c41a16>&#34;random error!&#34;</span>)

<span style=color:#a90d91>func</span> <span style=color:#000>maybeErr</span>(<span style=color:#000>err</span> <span style=color:#a90d91>error</span>, <span style=color:#000>pct</span> <span style=color:#a90d91>int</span>) <span style=color:#a90d91>error</span> {
	<span style=color:#a90d91>if</span> <span style=color:#000>err</span> <span style=color:#000>==</span> <span style=color:#a90d91>nil</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>rand</span>.<span style=color:#000>Intn</span>(<span style=color:#1c01ce>100</span>) &lt; <span style=color:#000>pct</span> {
		<span style=color:#000>err</span> = <span style=color:#000>randomError</span>
	}
	<span style=color:#a90d91>return</span> <span style=color:#000>err</span>
}
</code></pre></div><p>and then changed blocks of this form:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=color:#000>foo</span>, <span style=color:#000>err</span> <span style=color:#000>:=</span> <span style=color:#000>doSomething</span>()
<span style=color:#a90d91>if</span> <span style=color:#000>err</span> <span style=color:#000>!=</span> <span style=color:#a90d91>nil</span> {
	<span style=color:#a90d91>return</span> <span style=color:#000>err</span>
}
</code></pre></div><p>to this:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=color:#000>foo</span>, <span style=color:#000>err</span> <span style=color:#000>:=</span> <span style=color:#000>doSomething</span>()
<span style=color:#000>err</span> = <span style=color:#000>maybeErr</span>(<span style=color:#000>err</span>, <span style=color:#1c01ce>30</span>)
<span style=color:#a90d91>if</span> <span style=color:#000>err</span> <span style=color:#000>!=</span> <span style=color:#a90d91>nil</span> {
	<span style=color:#a90d91>return</span> <span style=color:#000>err</span>
}
</code></pre></div><p>This caused calls of <code>doSomething()</code>, usually a method call such as <a href=https://godoc.org/github.com/aws/aws-sdk-go/service/ec2#EC2.DescribeNetworkInterfaces target=_blank>DescribeNetworkInstances</a>, to fail 30% of the time when it would have otherwise succeeded.</p><p>Using these changes in a test Space with many instances let me get confidence that the process was idempotent. After a few rounds of scaling up and down I didn&rsquo;t see any leaked ENIs.</p><p>aws-sdk-go does have support for <a href=https://godoc.org/github.com/aws/aws-sdk-go/aws/request#Handlers target=_blank>request handlers</a> which I could have also used. A randomly-erroring <code>Send</code> handler would accomplish much the same thing but <code>maybeErr</code> let me inject errors in precise spots. It would be fun to apply generally, though.</p></article></article></main><footer><div class=content-container><div class=content>Hi, I&rsquo;m Dan. Usually danp.<p class=horizontal-links><a href=https://twitter.com/danp128 target=_blank>Twitter</a><a href=https://github.com/danp target=_blank>GitHub</a></p></div></div></footer><script>const emailId=atob("")</script><script src=/js/rocinante.min.js></script></body></html>