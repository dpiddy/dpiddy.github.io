<!doctype html><html><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Using postgression on Travis CI · Dan Peterson</title><link rel=stylesheet href=/css/rocinante.css><body><header><h2><a href=https://danp.net/>‹ Dan Peterson</a></h2></header><main><div class=post><div class=title-group><div class=title><h1>Using postgression on Travis CI</h1></div><div class=date><h5>May 12, 2013</h5></div></div><article class=content><p>At <a href=https://www.heroku.com target=_blank>Heroku</a> we use <a href=http://about.travis-ci.org/docs/user/travis-pro/ target=_blank>Travis CI</a> to run project tests on push to <a href=https://github.com/ target=_blank>GitHub</a>. While Travis CI offers <a href=http://about.travis-ci.org/docs/user/database-setup/#PostgreSQL target=_blank>PostgreSQL</a> in their environment, it&rsquo;s version 9.1. A project I&rsquo;m working on recently started using PostgreSQL 9.2&rsquo;s <a href=http://www.postgresql.org/docs/9.2/static/datatype-json.html target=_blank>JSON data type</a>, which 9.1 does not have.</p><p>Needing 9.2, I searched for ways to make it available in the Travis CI environment. I found guides that suggested <a href=http://reefpoints.dockyard.com/ruby/2013/03/29/running-postgresql-9.2-on-travis-ci.html target=_blank>upgrading PostgreSQL</a> in a <code>before_script</code> but I didn&rsquo;t have much luck with that approach. Plus, it would add time to each build which I was hoping to avoid. I knew <a href=https://postgres.heroku.com/ target=_blank>Heroku Postgres</a> offered 9.2 <a href=https://postgres.heroku.com/blog/past/2013/4/18/postgres_92_now_default/ target=_blank>by default</a>, what I really wanted was a fresh Heroku Postgres database for every test run.</p><p>Then I remembered <a href=http://www.postgression.com/ target=_blank>postgression</a>.</p><p>postgression is a service from <a href=http://www.rdegges.com/ target=_blank>rdegges</a> and <a href=http://zaidox.com/ target=_blank>zaidos</a>, built atop Heroku Postgres. It has a very simple API:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>$ curl http://api.postgression.com
postgres://user:password@host/db
</code></pre></div><p>The returned URL points to a Heroku Postgres database (running 9.2) which is automatically destroyed in 30 minutes, making it perfect for a Travis CI run.</p><p>My project connects to the database specified by <a href=http://12factor.net/config target=_blank><code>$DATABASE_URL</code></a>, so I needed to get that set to the URL returned by postgression. Before I started using the JSON data type, I used the <a href=http://about.travis-ci.org/docs/user/build-configuration/#Set-environment-variables target=_blank><code>env</code></a> section of <code>.travis.yml</code> to set <code>$DATABASE_URL</code> to <code>postgres://localhost/ci</code> and created the <code>ci</code> database in the <code>before_script</code> section. This worked well as settings in the <code>env</code> section are made available to all parts of the build: <code>before_script</code>, <code>script</code>, etc. To use a postgression database for <code>$DATABASE_URL</code>, I wanted the equivalent of:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#a90d91>export</span> <span style=color:#000>DATABASE_URL</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>curl http://api.postgression.com<span style=color:#a90d91>)</span>
</code></pre></div><p>The <code>env</code> section documentation has a note about needing to quote settings with asterisks (<code>*</code>) which got me wondering if specified settings were being evaluated by a shell. As an experiment, I changed my <code>env</code> section to:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=color:#000>env</span>:
- <span style=color:#1c01ce>DATABASE_URL=$(curl http://api.postgression.com)</span>
</code></pre></div><p>and it worked! The build output also confirmed this happened just once for the build instead of, say, once for <code>before_script</code> and again for <code>script</code>. This meant I had access to the same database in all parts of the build.</p><p>For a complete example in the wild, check out the <a href=https://github.com/erlware/dikdik/blob/e318019ca7e6c31bf50de15d2169382dc6a6f53f/.travis.yml target=_blank><code>.travis.yml</code></a> for <a href=https://github.com/erlware/dikdik target=_blank>dikdik</a>, an erlang hstore interface. Since dikdik also requires PostgreSQL 9.2, <a href=https://github.com/tsloughter target=_blank>tsloughter</a> adopted the approach described here to test it with Travis CI.</p><p>Thanks to a union of these two great services, testing projects requiring PostgreSQL 9.2 is easy. Please support them if you find them valuable!</p></article></article></main><footer><div class=content-container><div class=content>Hi, I&rsquo;m Dan. Usually danp.<p class=horizontal-links><a href=https://twitter.com/danp128 target=_blank>Twitter</a><a href=https://github.com/danp target=_blank>GitHub</a></p></div></div></footer><script>const emailId=atob("")</script><script src=/js/rocinante.min.js></script></body></html>